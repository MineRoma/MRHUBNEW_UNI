-- ТЕСТ PLATOBOOST API ДЛЯ DELTA
repeat task.wait(1) until game:IsLoaded()
task.wait(1)

local HttpService = game:GetService("HttpService")

local service = "16451" -- ЗАМЕНИ НА СВОЙ!

local function testNotify(title, text)
    pcall(function()
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = title,
            Text = tostring(text),
            Duration = 8
        })
    end)
    print("[TEST] " .. title .. ": " .. tostring(text))
end

-- Получаем request функцию
local fRequest = request or http_request or (http and http.request)

if not fRequest then
    testNotify("ERROR", "No request function!")
    return
end

-- Получаем HWID
local hwid = "unknown"
if gethwid then
    hwid = tostring(gethwid())
elseif getdeviceid then
    hwid = tostring(getdeviceid())
elseif getandroidid then
    hwid = tostring(getandroidid())
else
    hwid = tostring(game:GetService("Players").LocalPlayer.UserId)
end

testNotify("HWID", string.sub(hwid, 1, 20) .. "...")

-- Digest функция
local function lDigest(input)
    local inputStr = tostring(input)
    local hashHex = ""
    for i = 1, #inputStr do
        hashHex = hashHex .. string.format("%02x", string.byte(inputStr, i))
    end
    return hashHex
end

local identifier = lDigest(hwid)
testNotify("Identifier", string.sub(identifier, 1, 20) .. "...")

-- Тест 1: Connectivity
testNotify("Test 1", "Checking connectivity...")

local host = "https://api.platoboost.com"
local connSuccess, connResult = pcall(function()
    return fRequest({
        Url = host .. "/public/connectivity",
        Method = "GET"
    })
end)

if connSuccess and connResult then
    testNotify("Connectivity", "Status: " .. tostring(connResult.StatusCode))
    if connResult.StatusCode ~= 200 then
        host = "https://api.platoboost.net"
        testNotify("Host", "Switched to .net")
    end
else
    testNotify("Connectivity", "FAILED: " .. tostring(connResult))
end

-- Тест 2: Start (получение ссылки)
testNotify("Test 2", "Getting link...")

local requestBody = HttpService:JSONEncode({
    service = service,
    identifier = identifier
})

testNotify("Body", string.sub(requestBody, 1, 50))

local startSuccess, startResult = pcall(function()
    return fRequest({
        Url = host .. "/public/start",
        Method = "POST",
        Body = requestBody,
        Headers = {
            ["Content-Type"] = "application/json"
        }
    })
end)

if startSuccess and startResult then
    testNotify("Start Status", tostring(startResult.StatusCode))
    
    if startResult.Body then
        testNotify("Body Length", tostring(#startResult.Body))
        
        local decodeSuccess, decoded = pcall(function()
            return HttpService:JSONDecode(startResult.Body)
        end)
        
        if decodeSuccess and decoded then
            testNotify("Success Field", tostring(decoded.success))
            
            if decoded.success == true then
                if decoded.data and decoded.data.url then
                    testNotify("URL", string.sub(decoded.data.url, 1, 40) .. "...")
                    testNotify("RESULT", "ALL WORKING!")
                else
                    testNotify("ERROR", "No URL in data")
                    testNotify("Data", tostring(decoded.data))
                end
            else
                testNotify("API Error", tostring(decoded.message))
            end
        else
            testNotify("Decode Error", tostring(decoded))
            testNotify("Raw Body", string.sub(startResult.Body, 1, 100))
        end
    else
        testNotify("ERROR", "No body in response")
    end
else
    testNotify("Start FAILED", tostring(startResult))
end
